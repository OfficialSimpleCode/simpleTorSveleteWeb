var ie=Object.defineProperty;var oe=(i,e,t)=>e in i?ie(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var U=(i,e,t)=>(oe(i,typeof e!="symbol"?e+"":e,t),t);import{s as F,e as v,c as y,b as k,f as G,o as m,p as b,i as T,a as se,t as le,g as re,d as ue,z as q,h as _,q as ce,j as de,n as W,k as ae,A as fe}from"./scheduler.FRfybdjT.js";import{S as j,i as B,c as z,a as L,m as S,t as w,b as A,d as O,g as he,e as pe}from"./index.Fw8Tm96U.js";import{I as me,a as ge,e as Z}from"./Icon.OzKCNhzN.js";import{t as P,h as M,j as x,k as H,G as Ge,l as Ie,V as _e,p as J,m as K,n as N,E as V,o as ve,A as ye,P as be,U as h,q as D,r as Q,s as ke,D as Ce,v as Re,x as we,u as De,y as Ae,z as Ee,B as C,C as Pe,F as X,N as Y,H as Ue}from"./business_initializer.oBGNpB1Q.js";import{$ as ne}from"./runtime.HsTUf-wZ.js";function xe(i){let e,t,s,r;return t=new me({props:{src:ge,size:"26px"}}),{c(){e=v("div"),z(t.$$.fragment),this.h()},l(a){e=y(a,"DIV",{class:!0,"data-tip":!0});var n=k(e);L(t.$$.fragment,n),n.forEach(G),this.h()},h(){m(e,"class",s=i[2]?"absolute top-4 tooltip":""),m(e,"data-tip",i[0]),b(e,"right-4",i[1]=="right"),b(e,"tooltip-left",i[1]=="right"),b(e,"left-4",i[1]=="left"),b(e,"tooltip-right",i[1]=="left")},m(a,n){T(a,e,n),S(t,e,null),r=!0},p(a,[n]){(!r||n&4&&s!==(s=a[2]?"absolute top-4 tooltip":""))&&m(e,"class",s),(!r||n&1)&&m(e,"data-tip",a[0]),(!r||n&6)&&b(e,"right-4",a[1]=="right"),(!r||n&6)&&b(e,"tooltip-left",a[1]=="right"),(!r||n&6)&&b(e,"left-4",a[1]=="left"),(!r||n&6)&&b(e,"tooltip-right",a[1]=="left")},i(a){r||(w(t.$$.fragment,a),r=!0)},o(a){A(t.$$.fragment,a),r=!1},d(a){a&&G(e),O(t)}}}function Ne(i,e,t){let{message:s}=e,{location:r="right"}=e,{useAbsolute:a=!0}=e;return i.$$set=n=>{"message"in n&&t(0,s=n.message),"location"in n&&t(1,r=n.location),"useAbsolute"in n&&t(2,a=n.useAbsolute)},[s,r,a]}class Ve extends j{constructor(e){super(),B(this,e,Ne,xe,F,{message:0,location:1,useAbsolute:2})}}function Me(i){let e,t,s,r,a,n,o,c=P(M[i[0]],i[3])+"",l,g,u,p;return{c(){e=v("div"),t=v("button"),s=v("img"),n=se(),o=v("p"),l=le(c),this.h()},l(f){e=y(f,"DIV",{class:!0});var d=k(e);t=y(d,"BUTTON",{class:!0});var I=k(t);s=y(I,"IMG",{class:!0,src:!0,alt:!0}),n=re(I),o=y(I,"P",{class:!0});var R=k(o);l=ue(R,c),R.forEach(G),I.forEach(G),d.forEach(G),this.h()},h(){m(s,"class","w-full h-full object-scale-down rounded-lg p-3"),q(s.src,r=x[i[0]])||m(s,"src",r),m(s,"alt",a=x[i[0]]),m(o,"class","xs:text-md text-sm"),m(t,"class",g="rounded-lg btn-outline px-1 bg-base-300 border xs:h-[80px] xs:w-[80px] h-[60px] :w-[60px] hover:bg-primary "+(i[1]===i[0]?"border-primary":"border-gray-500")),m(e,"class","flex flex-col items-center justify-centers icon")},m(f,d){T(f,e,d),_(e,t),_(t,s),_(t,n),_(t,o),_(o,l),u||(p=ce(t,"click",i[4]),u=!0)},p(f,[d]){d&1&&!q(s.src,r=x[f[0]])&&m(s,"src",r),d&1&&a!==(a=x[f[0]])&&m(s,"alt",a),d&9&&c!==(c=P(M[f[0]],f[3])+"")&&de(l,c),d&3&&g!==(g="rounded-lg btn-outline px-1 bg-base-300 border xs:h-[80px] xs:w-[80px] h-[60px] :w-[60px] hover:bg-primary "+(f[1]===f[0]?"border-primary":"border-gray-500"))&&m(t,"class",g)},i:W,o:W,d(f){f&&G(e),u=!1,p()}}}function Fe(i,e,t){let s;ae(i,ne,c=>t(3,s=c));let{gender:r}=e,{pickedGender:a}=e,{handleClick:n}=e;const o=()=>n(r);return i.$$set=c=>{"gender"in c&&t(0,r=c.gender),"pickedGender"in c&&t(1,a=c.pickedGender),"handleClick"in c&&t(2,n=c.handleClick)},[r,a,n,s,o]}class Te extends j{constructor(e){super(),B(this,e,Fe,Me,F,{gender:0,pickedGender:1,handleClick:2})}}function $(i,e,t){const s=i.slice();return s[4]=e[t],s[6]=t,s}function ee(i){let e,t;return e=new Te({props:{pickedGender:i[0],gender:i[4],handleClick:i[2]}}),{c(){z(e.$$.fragment)},l(s){L(e.$$.fragment,s)},m(s,r){S(e,s,r),t=!0},p(s,r){const a={};r&1&&(a.pickedGender=s[0]),e.$set(a)},i(s){t||(w(e.$$.fragment,s),t=!0)},o(s){A(e.$$.fragment,s),t=!1},d(s){O(e,s)}}}function je(i){let e,t,s,r,a,n,o;r=new Ve({props:{useAbsolute:!1,message:P("genderInfo",i[1],!1)}});let c=Z(H),l=[];for(let u=0;u<c.length;u+=1)l[u]=ee($(i,c,u));const g=u=>A(l[u],1,1,()=>{l[u]=null});return{c(){e=v("div"),t=v("section"),s=v("div"),z(r.$$.fragment),a=se(),n=v("div");for(let u=0;u<l.length;u+=1)l[u].c();this.h()},l(u){e=y(u,"DIV",{class:!0});var p=k(e);t=y(p,"SECTION",{class:!0});var f=k(t);s=y(f,"DIV",{class:!0});var d=k(s);L(r.$$.fragment,d),d.forEach(G),a=re(f),n=y(f,"DIV",{class:!0});var I=k(n);for(let R=0;R<l.length;R+=1)l[R].l(I);I.forEach(G),f.forEach(G),p.forEach(G),this.h()},h(){m(s,"class","absolute top-1 w-full p-1"),m(n,"class","flex flex-row gap-2 px-4 xs:py-4 py-6 items-center justify-center"),m(t,"class","relative rounded-lg bg-base-100 xs:p-3 p-2 flex items-center justify-center gap-10 w-full"),m(e,"class","form-control")},m(u,p){T(u,e,p),_(e,t),_(t,s),S(r,s,null),_(t,a),_(t,n);for(let f=0;f<l.length;f+=1)l[f]&&l[f].m(n,null);o=!0},p(u,[p]){const f={};if(p&2&&(f.message=P("genderInfo",u[1],!1)),r.$set(f),p&5){c=Z(H);let d;for(d=0;d<c.length;d+=1){const I=$(u,c,d);l[d]?(l[d].p(I,p),w(l[d],1)):(l[d]=ee(I),l[d].c(),w(l[d],1),l[d].m(n,null))}for(he(),d=c.length;d<l.length;d+=1)g(d);pe()}},i(u){if(!o){w(r.$$.fragment,u);for(let p=0;p<c.length;p+=1)w(l[p]);o=!0}},o(u){A(r.$$.fragment,u),l=l.filter(Boolean);for(let p=0;p<l.length;p+=1)A(l[p]);o=!1},d(u){u&&G(e),O(r),fe(l,u)}}}function Be(i,e,t){let s;ae(i,ne,o=>t(1,s=o));let{pickedGender:r=Ge.male}=e,{onChanged:a=void 0}=e;function n(o){t(0,r=o),a!=null&&a(o)}return i.$$set=o=>{"pickedGender"in o&&t(0,r=o.pickedGender),"onChanged"in o&&t(3,a=o.onChanged)},[r,s,n,a]}class Je extends j{constructor(e){super(),B(this,e,Be,je,F,{pickedGender:0,onChanged:3})}}function ze(i){return i===null||i===""||/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(i)?null:P("invalidEmail")}const{v4:Le}=Ue,E=class E{constructor(){U(this,"userRepo",new Ie);U(this,"verificationRepo",new _e)}static GI(){return E._singleton}async createUser({gender:e,phone:t,email:s,isVerifiedPhone:r,isVerifiedEmail:a,userName:n,authProvider:o,userId:c}){const l=await this.userRepo.getDocSRV({path:J,docId:K(t)});if(l===void 0||l.exists()){N.GI().error=V.alreadyExistPhone;return}const g=new ve({id:c,name:n,email:s,isVerifiedPhone:r,isVerifiedEmail:a,phoneNumber:t,myBuisnessesIds:[],productsIds:{},lastVisitedBuisnessesRemoved:[],lastVisitedBuisnesses:[],revenueCatId:Le(),gender:e});g.authProviders=o?new Map([[o,new Date]]):new Map;let u;if(o===ye.Phone&&r&&(u=await this.mergePhoneCollectionWithUser(g,t,{fromCreateUser:!0}),u||(g.isVerifiedPhone=!1)),!!await this.userRepo.createUser({user:g}))return u||new be}async mergePhoneCollectionWithUser(e,t,{fromCreateUser:s=!1}){const r=await this.userRepo.mergePhoneDataWithUser({phone:t,userId:e.id,name:e.name});if(!(r===void 0&&N.GI().error===V.alreadyExistPhone))return r}async updateCreditCardsPassword(e,t){const s={},r={};return e!==""&&Object.entries(h.GI().user.paymentCards).forEach(([a,n])=>{Object.entries(n).forEach(([o,c])=>{const g=c.decryptCard(e).encryptCard(t);s[a]??(s[a]={}),s[a][o]=g,r[a]??(r[a]={}),r[a][o]=g.toJson()})}),await this.userRepo.updateMultipleFieldsInsideDocAsMapRepo({docId:h.GI().user.id,path:D,data:{cardPaymentsPass:Q(t),paymentCards:r}}).then(async a=>(a&&(h.GI().user.cardPaymentsPass=Q(t),h.GI().user.paymentCards=s),a))}async updateEmail(e,{isVerified:t=!1}={}){return ze(e)!==null?(N.GI().error=V.illegalFields,!1):e===h.GI().user.userPublicData.email?!0:ke(h.GI().user.lastTimeUpdateEmail,new Ce({days:1}))>new Date?(N.GI().error=V.cantUpdateEmailTooShortTimeBetween,!1):(h.GI().user.userPublicData.email=e,await this.userRepo.updateMultipleFieldsInsideDocAsMapRepo({path:`${D}/${h.GI().user.id}/${Re}`,docId:we,data:{email:e,isVerifiedEmail:t}}).then(async s=>{if(s){h.GI().user.userPublicData.isVerifiedEmail=t;const r=new Date;return await this.userRepo.updateFieldInsideDocAsMapRepo({path:D,docId:h.GI().user.id,fieldName:"lastTimeUpdateEmail",value:r.toString()}).then(a=>(a&&(h.GI().user.lastTimeUpdateEmail=r),a))}return s}))}async updateSeenUpdates(e,t){return new Set([...h.GI().user.seenUpdates[e]].filter(r=>t.has(r))).size===t.size?!0:(h.GI().user.seenUpdates[e]=new Set([...t]),await this.userRepo.updateFieldInsideDocAsMapRepo({path:D,docId:h.GI().user.id,fieldName:`seenUpdates.${e}`,value:Array.from(t)}))}async setGender(e){return e===h.GI().user.gender?(console.log("22222222222222222222"),!0):(console.log("eeeeeeeeeeeeeeeee"),h.GI().user.gender=e,De.set(h.GI().user),await this.userRepo.updatePublicUserField({userId:h.GI().user.id,fieldName:"gender",value:M[e],businessesIds:Object.keys(h.GI().user.userPublicData.permission)}).then(t=>(console.log("33333333333",t),t)))}async updateName(e){if(e===h.GI().user.name)return!0;const t=h.GI().user;return t.name=e,await this.userRepo.updatePublicUserField({userId:t.id,businessesIds:Object.keys(t.userPublicData.permission),fieldName:"name",value:e}).then(async s=>{if(s){const r=[];t.userPublicData.myBuisnessesIds.forEach(a=>{r.push(this.userRepo.updateFieldInsideDocAsMapRepo({fieldName:"ownersName",docId:a,path:Ae,value:e}).then(n=>{n&&a==Ee.currentBusinesssId&&(C.GI().business.ownersName=e)}))}),t.isVerifiedPhone&&r.push(this.userRepo.updateFieldInsideDocAsMapRepo({fieldName:"name",docId:K(t.phoneNumber),path:J,value:e})),await Promise.all(r)}return s})}async addOrRemoveLikeForStoryImage(e,t,s,r){var n;const a=await this.userRepo.updateFieldInsideDocAsArrayRepo({path:D,docId:s,fieldName:"storyLikes",value:e,command:r});if(a){const o=((n=C.GI().workers[t])==null?void 0:n.storylikesAmount[e])??0;r===Pe.add?(await this.userRepo.incrementNumberChild({childPath:X.GI().getLisksChildPath(t),valueId:e,delta:1,command:Y.increment}),h.GI().user.storyLikes.push(e),C.GI().workers[t]&&(C.GI().workers[t].storylikesAmount[e]=o+1)):(o>=0&&(await this.userRepo.incrementNumberChild({childPath:X.GI().getLisksChildPath(t),valueId:e,delta:1,command:Y.decrement}),C.GI().workers[t]&&(C.GI().workers[t].storylikesAmount[e]=Math.max(C.GI().workers[t].storylikesAmount[e]-1,0))),h.GI().user.storyLikes=h.GI().user.storyLikes.filter(c=>c!=e))}return a}};U(E,"_singleton",new E);let te=E;export{Je as G,Ve as I,te as U};
