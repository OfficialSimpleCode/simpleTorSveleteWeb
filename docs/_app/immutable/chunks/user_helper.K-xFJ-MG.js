var Y=Object.defineProperty;var $=(i,e,t)=>e in i?Y(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var D=(i,e,t)=>($(i,typeof e!="symbol"?e+"":e,t),t);import{s as A,e as _,c as k,b as v,f as g,m,p,i as N,o as z,h as E,r as ee,n as O,a as te,g as se,w as re,k as ae}from"./scheduler.zcY2-Ylb.js";import{S as M,i as T,c as V,a as F,m as B,t as I,b as C,d as L,g as ne,e as ie}from"./index.yLZX-Kca.js";import{e as j}from"./each.n4ZBfOh4.js";import{I as oe,a as le}from"./Icon.0Xqd87zn.js";import{e as w,t as U,f as q,G as ce,h as ue,V as de,p as W,j as Z,k as P,E as b,l as fe,A as he,P as me,U as u,m as y,n as x,o as pe,D as ge,q as Ge,r as Ie,u as _e,s as ke,v as ye,w as Ce,B as G,x as Re,y as H,N as J,z as ve}from"./business_initializer.EhT-bDmR.js";import{$ as De}from"./runtime.XCz8e1Wr.js";function we(i){let e,t,s;return t=new oe({props:{src:le,size:"26px"}}),{c(){e=_("div"),V(t.$$.fragment),this.h()},l(r){e=k(r,"DIV",{class:!0,"data-tip":!0});var a=v(e);F(t.$$.fragment,a),a.forEach(g),this.h()},h(){m(e,"class","absolute top-4 tooltip"),m(e,"data-tip",i[0]),p(e,"right-4",i[1]=="right"),p(e,"tooltip-left",i[1]=="right"),p(e,"left-4",i[1]=="left"),p(e,"tooltip-right",i[1]=="left")},m(r,a){N(r,e,a),B(t,e,null),s=!0},p(r,[a]){(!s||a&1)&&m(e,"data-tip",r[0]),(!s||a&2)&&p(e,"right-4",r[1]=="right"),(!s||a&2)&&p(e,"tooltip-left",r[1]=="right"),(!s||a&2)&&p(e,"left-4",r[1]=="left"),(!s||a&2)&&p(e,"tooltip-right",r[1]=="left")},i(r){s||(I(t.$$.fragment,r),s=!0)},o(r){C(t.$$.fragment,r),s=!1},d(r){r&&g(e),L(t)}}}function Pe(i,e,t){let{message:s}=e,{location:r="right"}=e;return i.$$set=a=>{"message"in a&&t(0,s=a.message),"location"in a&&t(1,r=a.location)},[s,r]}class be extends M{constructor(e){super(),T(this,e,Pe,we,A,{message:0,location:1})}}function Ee(i){let e,t,s,r,a,c,n;return{c(){e=_("div"),t=_("button"),s=_("img"),this.h()},l(f){e=k(f,"DIV",{class:!0});var o=v(e);t=k(o,"BUTTON",{class:!0});var l=v(t);s=k(l,"IMG",{class:!0,src:!0,alt:!0}),l.forEach(g),o.forEach(g),this.h()},h(){m(s,"class","w-10 h-10"),z(s.src,r=w[i[0]])||m(s,"src",r),m(s,"alt",a=w[i[0]]),m(t,"class","btn sm:btn-lg btn-outline w-full"),p(t,"text-gray-500",i[1]!=i[0]),m(e,"class","icon")},m(f,o){N(f,e,o),E(e,t),E(t,s),c||(n=ee(t,"click",i[3]),c=!0)},p(f,[o]){o&1&&!z(s.src,r=w[f[0]])&&m(s,"src",r),o&1&&a!==(a=w[f[0]])&&m(s,"alt",a),o&3&&p(t,"text-gray-500",f[1]!=f[0])},i:O,o:O,d(f){f&&g(e),c=!1,n()}}}function Ue(i,e,t){let{gender:s}=e,{pickedGender:r}=e,{handleClick:a}=e;const c=()=>a(s);return i.$$set=n=>{"gender"in n&&t(0,s=n.gender),"pickedGender"in n&&t(1,r=n.pickedGender),"handleClick"in n&&t(2,a=n.handleClick)},[s,r,a,c]}class Ae extends M{constructor(e){super(),T(this,e,Ue,Ee,A,{gender:0,pickedGender:1,handleClick:2})}}function K(i,e,t){const s=i.slice();return s[4]=e[t],s[6]=t,s}function Q(i){let e,t;return e=new Ae({props:{pickedGender:i[0],gender:i[4],handleClick:i[2]}}),{c(){V(e.$$.fragment)},l(s){F(e.$$.fragment,s)},m(s,r){B(e,s,r),t=!0},p(s,r){const a={};r&1&&(a.pickedGender=s[0]),e.$set(a)},i(s){t||(I(e.$$.fragment,s),t=!0)},o(s){C(e.$$.fragment,s),t=!1},d(s){L(e,s)}}}function Ne(i){let e,t,s,r,a;s=new be({props:{message:U("genderInfo",i[1],!1)}});let c=j(q),n=[];for(let o=0;o<c.length;o+=1)n[o]=Q(K(i,c,o));const f=o=>C(n[o],1,1,()=>{n[o]=null});return{c(){e=_("div"),t=_("section"),V(s.$$.fragment),r=te();for(let o=0;o<n.length;o+=1)n[o].c();this.h()},l(o){e=k(o,"DIV",{class:!0});var l=v(e);t=k(l,"SECTION",{class:!0});var h=v(t);F(s.$$.fragment,h),r=se(h);for(let d=0;d<n.length;d+=1)n[d].l(h);h.forEach(g),l.forEach(g),this.h()},h(){m(t,"class","relative rounded-lg bg-base-100 p-6 flex items-center justify-center gap-10 w-full"),m(e,"class","form-control")},m(o,l){N(o,e,l),E(e,t),B(s,t,null),E(t,r);for(let h=0;h<n.length;h+=1)n[h]&&n[h].m(t,null);a=!0},p(o,[l]){const h={};if(l&2&&(h.message=U("genderInfo",o[1],!1)),s.$set(h),l&5){c=j(q);let d;for(d=0;d<c.length;d+=1){const S=K(o,c,d);n[d]?(n[d].p(S,l),I(n[d],1)):(n[d]=Q(S),n[d].c(),I(n[d],1),n[d].m(t,null))}for(ne(),d=c.length;d<n.length;d+=1)f(d);ie()}},i(o){if(!a){I(s.$$.fragment,o);for(let l=0;l<c.length;l+=1)I(n[l]);a=!0}},o(o){C(s.$$.fragment,o),n=n.filter(Boolean);for(let l=0;l<n.length;l+=1)C(n[l]);a=!1},d(o){o&&g(e),L(s),re(n,o)}}}function Me(i,e,t){let s;ae(i,De,n=>t(1,s=n));let{pickedGender:r=ce.male}=e,{onChanged:a=void 0}=e;function c(n){t(0,r=n),a!=null&&a(n)}return i.$$set=n=>{"pickedGender"in n&&t(0,r=n.pickedGender),"onChanged"in n&&t(3,a=n.onChanged)},[r,s,c,a]}class qe extends M{constructor(e){super(),T(this,e,Me,Ne,A,{pickedGender:0,onChanged:3})}}function Te(i){return i===null||i===""||/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(i)?null:U("invalidEmail")}const{v4:Ve}=ve,R=class R{constructor(){D(this,"userRepo",new ue);D(this,"verificationRepo",new de)}static GI(){return R._singleton}async createUser({gender:e,phone:t,email:s,isVerifiedPhone:r,isVerifiedEmail:a,userName:c,authProvider:n,userId:f}){const o=await this.userRepo.getDocSRV({path:W,docId:Z(t)});if(o===void 0||o.exists()){P.GI().error=b.alreadyExistPhone;return}const l=new fe({id:f,name:c,email:s,isVerifiedPhone:r,isVerifiedEmail:a,phoneNumber:t,myBuisnessesIds:[],productsIds:{},lastVisitedBuisnessesRemoved:[],lastVisitedBuisnesses:[],revenueCatId:Ve(),gender:e});l.authProviders=n?new Map([[n,new Date]]):new Map;let h;if(n===he.Phone&&r&&(h=await this.mergePhoneCollectionWithUser(l,t,{fromCreateUser:!0}),h||(l.isVerifiedPhone=!1)),!!await this.userRepo.createUser({user:l}))return h||new me}async mergePhoneCollectionWithUser(e,t,{fromCreateUser:s=!1}){const r=await this.userRepo.mergePhoneDataWithUser({phone:t,userId:e.id,name:e.name});if(!(r===void 0&&P.GI().error===b.alreadyExistPhone))return r}async updateCreditCardsPassword(e,t){const s={},r={};return e!==""&&Object.entries(u.GI().user.paymentCards).forEach(([a,c])=>{Object.entries(c).forEach(([n,f])=>{const l=f.decryptCard(e).encryptCard(t);s[a]??(s[a]={}),s[a][n]=l,r[a]??(r[a]={}),r[a][n]=l.toJson()})}),await this.userRepo.updateMultipleFieldsInsideDocAsMapRepo({docId:u.GI().user.id,path:y,data:{cardPaymentsPass:x(t),paymentCards:r}}).then(async a=>(a&&(u.GI().user.cardPaymentsPass=x(t),u.GI().user.paymentCards=s),a))}async updateEmail(e,{isVerified:t=!1}={}){return Te(e)!==null?(P.GI().error=b.illegalFields,!1):e===u.GI().user.userPublicData.email?!0:pe(u.GI().user.lastTimeUpdateEmail,new ge({days:1}))>new Date?(P.GI().error=b.cantUpdateEmailTooShortTimeBetween,!1):(u.GI().user.userPublicData.email=e,await this.userRepo.updateMultipleFieldsInsideDocAsMapRepo({path:`${y}/${u.GI().user.id}/${Ge}`,docId:Ie,data:{email:e,isVerifiedEmail:t}}).then(async s=>{if(s){u.GI().user.userPublicData.isVerifiedEmail=t;const r=new Date;return await this.userRepo.updateFieldInsideDocAsMapRepo({path:y,docId:u.GI().user.id,fieldName:"lastTimeUpdateEmail",value:r.toString()}).then(a=>(a&&(u.GI().user.lastTimeUpdateEmail=r),a))}return s}))}async updateSeenUpdates(e,t){return new Set([...u.GI().user.seenUpdates[e]].filter(r=>t.has(r))).size===t.size?!0:(u.GI().user.seenUpdates[e]=new Set([...t]),await this.userRepo.updateFieldInsideDocAsMapRepo({path:y,docId:u.GI().user.id,fieldName:`seenUpdates.${e}`,value:Array.from(t)}))}async setGender(e){return e===u.GI().user.gender?(console.log("22222222222222222222"),!0):(console.log("eeeeeeeeeeeeeeeee"),u.GI().user.gender=e,_e.set(u.GI().user),await this.userRepo.updatePublicUserField({userId:u.GI().user.id,fieldName:"gender",value:ke[e],businessesIds:Object.keys(u.GI().user.userPublicData.permission)}).then(t=>(console.log("33333333333",t),t)))}async updateName(e){if(e===u.GI().user.name)return!0;const t=u.GI().user;return t.name=e,await this.userRepo.updatePublicUserField({userId:t.id,businessesIds:Object.keys(t.userPublicData.permission),fieldName:"name",value:e}).then(async s=>{if(s){const r=[];t.userPublicData.myBuisnessesIds.forEach(a=>{r.push(this.userRepo.updateFieldInsideDocAsMapRepo({fieldName:"ownersName",docId:a,path:ye,value:e}).then(c=>{c&&a==Ce.currentBusinesssId&&(G.GI().business.ownersName=e)}))}),t.isVerifiedPhone&&r.push(this.userRepo.updateFieldInsideDocAsMapRepo({fieldName:"name",docId:Z(t.phoneNumber),path:W,value:e})),await Promise.all(r)}return s})}async addOrRemoveLikeForStoryImage(e,t,s,r){var c;const a=await this.userRepo.updateFieldInsideDocAsArrayRepo({path:y,docId:s,fieldName:"storyLikes",value:e,command:r});if(a){const n=((c=G.GI().workers[t])==null?void 0:c.storylikesAmount[e])??0;r===Re.add?(await this.userRepo.incrementNumberChild({childPath:H.GI().getLisksChildPath(t),valueId:e,delta:1,command:J.increment}),u.GI().user.storyLikes.push(e),G.GI().workers[t]&&(G.GI().workers[t].storylikesAmount[e]=n+1)):(n>=0&&(await this.userRepo.incrementNumberChild({childPath:H.GI().getLisksChildPath(t),valueId:e,delta:1,command:J.decrement}),G.GI().workers[t]&&(G.GI().workers[t].storylikesAmount[e]=Math.max(G.GI().workers[t].storylikesAmount[e]-1,0))),u.GI().user.storyLikes=u.GI().user.storyLikes.filter(f=>f!=e))}return a}};D(R,"_singleton",new R);let X=R;export{qe as G,be as I,X as U};
